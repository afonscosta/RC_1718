\documentclass{llncs}
\usepackage{times}
\usepackage[T1]{fontenc}

% Comentar para not MAC Users
%\usepackage[applemac]{inputenc}

\usepackage{a4}
%\usepackage[margin=3cm,nohead]{geometry}
\usepackage{epstopdf}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage{amsmath}
\usepackage{subcaption}
\usepackage[bookmarks=false]{hyperref}
%\renewcommand{\baselinestretch}{1.5}

\begin{document}
\mainmatter
\title{TP2: Protocolo IP}

\titlerunning{TP2: Protocolo IP}

\author{Diogo Afonso Costa \and Daniel Maia \and Vitor Castro}

\authorrunning{Diogo Afonso Costa \and Daniel Maia \and Vitor Castro}


\institute{
University of Minho, Department of  Informatics, 4710-057 Braga, Portugal\\
e-mail: \{a78034,a77531,a77870\}@alunos.uminho.pt
}

\date{}
\bibliographystyle{splncs}

\maketitle
\begin{abstract}
Resumo...
\end{abstract}

\section{Introdução}

\section{Parte I - Datagramas e Fragmentação}

\subsection{Exercício 1.b.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 1.c.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 1.d.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

% Exercicio 2 --------------------

\subsection{Exercício 2.a.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
Qual é o endereço IP da interface ativa do seu computador?

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
O endereço IP é 192.168.100.216. 

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\
\begin{figure}
	\begin{center}
	\includegraphics[scale=0.35]{imagens/ip_source_proof.png} 
	\end{center}
	\caption{\label{fig:ip_source}Identificação do endereço IP.}
\end{figure} 

% ------

\subsection{Exercício 2.b.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Qual é o valor do campo protocolo? O que identifica?

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

O campo protocolo tem o valor "ICMP (1)". ICMP significa \textit{Internet Control Message Protocol}. Este é utilizado para reportar erros no processamento de datagramas. Efetivamente, dentro dos possíveis erros temos, \textit{destination unreachable} (quando o datagrama não consegue alcançar o destino), \textit{time exceeded message} (quando um \textit{gateway} processa um datagrama e descobre que o \textit{TTL} é zero e tem que descartar o datagrama e consequentemente notificar o \textit{host}), \textit{echo request/reply} (quando são enviadas mensagens para funções de teste e controle da rede (\textit{request}), caso a máquina esteja ligada responde com um \textit{reply}) \cite{rfc792} \cite{wiki:ICMP_echo}. Como as mensagens ICMP encontram-se ao nível de rede, estas são também elas encapsuladas em datagramas IP que, consequentemente, usam o protocolo IP.

Assim sendo, analisando a primeira mensagem ICMP, nomeadamente no separador do \textit{Internet Protocol Version 4}, percebemos que se trata de uma mensagem que vem num protocolo \textit{ICMP}. Além disso, é possível concluir que se trata de uma mensagem de \textit{echo request}, se observarmos o campo \textit{Type} no separador \textit{Internet Control Message Protocol}. Desta forma, pode-se concluir que o computador usado para a resolução deste trabalho está a tentar perceber se consegue estabelecer uma ligação com o \textit{host} marco.uminho.pt e para isso usa mensagens \textit{ICMP} do tipo \textit{echo request}.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\
\begin{figure}
	\begin{center}
	\includegraphics[scale=0.35]{./imagens/icmp_1.png} 
	\end{center}
	\caption{\label{fig:icmp_1}Identificação do campo \textit{Protocol}.}
\end{figure} 

% ------

\subsection{Exercício 2.c.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Quantos bytes tem o cabeçalho IP(v4)? Quantos bytes tem o campo de dados (payload) do datagrama? Como se calcula o tamanho do payload?  

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
	
O cabeçalho IPv4 tem 20 bytes.

O campo de dados (payload) do datagrama tem 40 bytes.

O cálculo do payload é feito retirando o tamanho do cabeçalho ao tamanho total do datagrama (60 bytes). Desta forma, basta fazer \(60 - 20 = 40 bytes\).

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\
\begin{figure}
	\begin{center}
	\includegraphics[scale=0.35]{./imagens/icmp_size.png} 
	\end{center}
	\caption{\label{fig:icmp_size}Identificação do tamanho do \textit{header} e do \textit{payload}.}
\end{figure} 

% ------

\subsection{Exercício 2.d.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

O datagrama IP foi fragmentado? Justifique.

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

A fragmentação acontece quando o tamanho total do datagrama excede o \textit{MTU} disponível. Tendo em conta que por defeito o \textit{traceroute} usa 60 bytes por datagrama e tem-se um \textit{MTU} disponível de 1500 bytes, podemos conjeturar que não haverá fragmentação.
	
A verificação se um datagrama foi ou não fragmentado é feita com base em dois valores, o \textit{fragment offset} (indica o \textit{offset} em que o datagrama atual encaixa no datagrama original) e a \textit{flag more fragments} (indica se existe mais fragmentos). Neste datagrama em específico o \textit{fragment offset} = 0 e a \textit{flag more fragments} = 0. Desta forma, tendo em conta o \textit{fragment offset}, sabe-se que se o datagrama foi fragmentado então ele é necessariamente o primeiro. Além disso, se analisarmos a \textit{flag more fragments} concluímos que para além do datagrama atual não existe mais nenhum associado a este. 

Assim sendo, conjugando a informação dos dois parâmetros percebe-se que se o datagrama é o primeiro e não existe mais nenhum associado, então este é único e não foi fragmentado.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\
\begin{figure}
	\begin{center}
	\includegraphics[scale=0.35]{./imagens/icmp_frag.png} 
	\end{center}
	\caption{\label{fig:icmp_frag}Fragmentação.}
\end{figure} 

% ------

\subsection{Exercício 2.e.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Ordene os pacotes capturados de acordo com o endereço IP fonte (e.g., selecionando o cabeçalho da coluna Source), e analise a sequência de tráfego ICMP gerado a partir do endereço IP atribuído à sua máquina. Para a sequência de mensagens ICMP enviadas pelo seu computador, indique que campos do cabeçalho IP variam de pacote para pacote.  

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

Os campos que vêm os seus valores alterados correspondem à \textit{identification}, \textit{header checksum} e \textit{time to live (TTL)}. 

A \emph{identificação} muda pois este campo identifica unicamente cada datagrama e visto que estes são sempre diferentes então o campo também o será.

O \textit{header checksum} permite verificar que determinado header foi ou não corrompido. Desta forma o \textit{checksum} identifica um determinado \textit{header} num determinado estado. Assim sendo, o \textit{checksum} muda pois este campo utiliza no seu algoritmo todas as palavras de 16 bits do \textit{header} \cite{rfc792}. Efetivamente, sabendo que o \textit{header}, propriamente dito, muda de datagrama para datagrama então o seu \textit{checksum} também vai mudar.

O \textit{TTL} muda pois a máquina que está a ser usada está a tentar contactar o \textit{host} marco.uminho.pt. Começa por tentar com \(TTL = 1\) e o pacote é descartado. Desta forma, vai aumentado o \textit{TTL} até conseguir chegar ao \textit{host} pretendido.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\begin{figure}[h]
	\centering
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_TTL_1.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_TTL_2.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_TTL_3.png}
	\end{subfigure}
	\caption{Campos que mudam.}
	\label{fig:field_change}
\end{figure}

% ------

\subsection{Exercício 2.f.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Observa algum padrão nos valores do campo de Identificação do datagrama IP e TTL? 

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

O campo da indentificação corresponde a um valor que é incrementado e que identifica unicamente o datagrama em questão. Por exemplo, se o primeiro datagrama tiver \textit{Identification} 0xb224 (45604), então o datagrama seguinte terá o valor 0xb225 (45605). 

O TTL corresponde a uma variável que vai sendo decrementada sempre que é intersetada por um \textit{router}. Visto que na primeira mensagem o TTL é 1, o datagrama é descartado imediatamente no primeiro \textit{router}. Deste modo, é enviado, de seguida, um novo datagrama com TTL a 2 com a esperança de que este chegue desta vez ao destino. Caso não chegue, então no próximo datagrama o TTL será aumentado, e assim sucessivamente, até chegar ao destino.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

A relação entre \textit{TTL} pode ser observada na figura ~\ref{fig:field_change}.

\begin{figure}[h]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_1_id.png}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_2_id.png}
	\end{subfigure}
	\caption{Identificação.}
	\label{fig:field_id}
\end{figure}

% ------

\subsection{Exercício 2.g.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Ordene o tráfego capturado por endereço destino e encontre a série de respostas ICMP TTL exceeded enviadas ao seu computador. Qual é o valor do campo TTL? Esse valor permanece constante para todas as mensagens de resposta ICMP TTL exceeded enviados ao seu host? Porquê? 

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

O IP 192.168.100.254 referencia a interface do primeiro router de acesso (visto ter o três primeiros campos iguais ao da máquina em que os testes estão a ser feitos e o último utiliza um número convencionado para ser utilizado para identificar a interface IP do router dentro da rede 192.168.100, na qual a máquina de testes se encontra).

Desta forma, quando analisamos os datagramas do 192.168.100.254 percebemos que estes têm todos o \textit{TTL} = 64. O \textit{TTL} toma um valor exageradamente elevado, devido ao desconhecimento que este tem da distância a que o \textit{host} de destino se encontra. Por defeito, este router quando não tem informação da distância a que o \textit{host} de destino se encontra envia datagramas com \textit{TTL} = 64 e por isso todas os seus datagramas tem \textit{TTL} igual.

Além disso, é possível concluir que as três mensagens recebidas deste router com \textit{ICMP \textit{TTL} exceeded} são a resposta ao envio feito pela máquina de testes de três datagramas de \textit{echo (ping) request} com \textit{TTL} apenas de 1. Estes datagramas chegaram ao \textit{router} de acesso e ficaram com o \textit{TTL} a 0 e a exceção veio enviado de no datagrama \textit{ICMP \textit{TTL} exceeded}.

Após estes datagramas é possível identificar um segundo conjunto de datagramas desta vez da interface IP 193.136.19.254. Pelo mesmo raciocínio podemos assumir que o IP desta interface identifica um \textit{router}. Este novo \textit{router} envia datagramas com \textit{TTL} = 254 (constante). Este valor é considerável pela mesma razão explicitada anteriormente. Estes datagramas são a resposta a 3 datagramas enviados pela máquina de testes com \textit{TTL} = 2, o que nos leva a concluir que é o segundo router por qual o nosso datagrama teve de passar para chegar ao marco.uminho.pt.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\begin{figure}[h]
	\centering
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_1_TTL64_router.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_2_TTL64_router.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_3_TTL64_router.png}
	\end{subfigure}
	\caption{Router de acesso com \textit{TTL} = 64.}
	\label{fig:field_change}
\end{figure}

\begin{figure}[h]
	\centering
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_1_TTL254_router.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_2_TTL254_router.png}
	\end{subfigure}%
	\begin{subfigure}{.4\textwidth}
		\centering
		\includegraphics[width=0.98\linewidth]{./imagens/icmp_3_TTL254_router.png}
	\end{subfigure}
	\caption{Segundo router com \textit{TTL} = 254.}
	\label{fig:field_change}
\end{figure}

% Exercicio 3 --------------------

\subsection{Exercício 3.a.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\

Localize a primeira mensagem ICMP. Porque é que houve necessidade de fragmentar o pacote inicial?

\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\

O pacote inicial tem um \textit{total length} de 3033 bytes. O MTU (\textit{Maximum Transmission Unit} disponível é de apenas 1500 bytes e, como tal, o pacote inicial tem de ser fragmentado para que este possa ser transmitido na rede.

\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\begin{figure}
	\begin{center}
	\includegraphics[scale=0.35]{./imagens/packet_frag.png} 
	\end{center}
	\caption{\label{fig:icmp_frag}A MTU é menor do que o pacote.}
\end{figure} 

\subsection{Exercício 3.b.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 3.c.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 3.d.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 3.e.}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\


\pagebreak
\section{Parte II - Endereçamento e Encaminhamento IP}

\subsection{Exercício 2.1.a}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.1.b}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.1.c}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.1.d}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.1.e}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

% Exercicio 2 --------------------

\subsection{Exercício 2.2.a}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.2.b}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.2.c}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.2.d}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 2.2.e}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

% Exercicio 3 --------------------

\subsection{Exercício 3.1}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 3.2}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\

\subsection{Exercício 3.3}
\subsubsection{Questão}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Resposta}\rule[-10pt]{0pt}{10pt}\\
\subsubsection{Realização}\rule[-10pt]{0pt}{10pt}\\








% ------------------------------------------------------------------- 
% LIXO --------------------------------------------------------------
% ------------------------------------------------------------------- 

%UNCOMMENT se necessrio
%De acordo com o ilustrado na Figura~\ref{fig:controller}
%% Exemplo para insero de uma figura
%\begin{figure}
%\begin{center}
%\includegraphics[scale=0.40]{figura.pdf} 
%\end{center}
%\caption{\label{fig:controller}Architecture of the unified QoS metric fuzzy controller.}
%\end{figure} 

According to Table~\ref{tab:TabelaExemplo}...

% Exemplo de uma tabela com duas colunas
\begin{figure}
\centering
\begin{tabular}{|c|c|}\hline
(a) Delay and jiiter & (b) Delay and loss \\ \hline

(c) Delay and throughput & (d) Jitter and loss \\ \hline

(e) Jitter and throughput & (f) Loss and throughput \\ \hline
\end{tabular}
\caption{\label{tab:TabelaExemplo}Tabela exemplo.}
\end{figure}

%\section{Simulation Scenario}

\section{Conclusions}
Neste trabalho...

%BIBLIOGRAFIA
\bibliographystyle{splncs}
\bibliography{ficheirodebibliografia}

\end{document}
